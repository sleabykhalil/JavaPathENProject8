version: "3.9"

x-logging:
  &logging
  logging:
    driver: json-file
    options:
      max-size: "200k"
      max-file: "10"
networks:
  traefik-net:
    name: traefik-net
    driver: bridge

services:
  microservice_gps:
    build: ./gps-api
    #ports:
    #  - "8083:8083"
    expose:
      - 8083
    #container_name: "tourguideGpsApi"
    networks:
      - traefik-net
    deploy:
      #mode: replicated
      replicas: 2
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.port=80"
      - "traefik.http.routers.demo1.rule=Host(`gps.localhost`)"

  microservice_reward:
    build: ./reward-api
    ports:
      - "8082:8082"
    container_name: "tourguideRewardApi"
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.port=80"
      - "traefik.http.routers.demo1.rule=Host(`reward.localhost`)"

  microservice_users:
    build: ./user-api
    ports:
      - "8081:8081"
    #container_name: "tourguideUserApi"
    labels:
      - traefik.backend=users
      - "traefik.frontend.rule=PathPrefixStrip:/users"

#  microservice_tourguide:
#    build: ./TourGuide
#    container_name: "tourguideMainApi"

  traefik:
    #image: traefik:v1.7.14-alpine
    image: traefik:v2.3.0
    command:
      - "--api.insecure=true"
      - "--providers.docker"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    networks:
      - traefik-net
    labels:
      - "traefik.http.routers.dashboard.rule=Host(`dash.localhost`)"
      - "traefik.docker.network=traefik-net"
    volumes:
      - "//var/run/docker.sock:/var/run/docker.sock"
      #- "////./pipe/docker_engine:////./pipe/docker_engine"
      #- "////./pipe/docker_engine:/var/run/docker.sock"
    <<: *logging
    restart: unless-stopped

#http://dash:localhost:8080/dashboard/#/